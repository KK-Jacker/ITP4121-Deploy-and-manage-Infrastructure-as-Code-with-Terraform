"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.KubernetesClusterSConstruct = void 0;
const constructs_1 = require("constructs");
const provider_azurerm_1 = require("@cdktf/provider-azurerm");
const provider_null_1 = require("@cdktf/provider-null");
const data_local_file_1 = require("../.gen/providers/local/data-local-file");
class KubernetesClusterSConstruct extends constructs_1.Construct {
    constructor(scope, name, props) {
        super(scope, name);
        const { resourceGroup, virtualNetwork } = props;
        // create container registry
        this.kubernetesCluster = new provider_azurerm_1.KubernetesCluster(this, "ITP4121-Project kubernetes Cluster", {
            name: process.env.PROJECT_NAME + process.env.ENV,
            resourceGroupName: resourceGroup.name,
            location: resourceGroup.location,
            dnsPrefix: process.env.PROJECT_NAME + process.env.ENV + "-dns",
            defaultNodePool: [{
                    name: "np01",
                    nodeCount: 1,
                    vmSize: "Standard_D4s_v3",
                    availabilityZones: ["1", "2", "3"],
                    enableAutoScaling: true,
                    minCount: 1,
                    maxCount: 3,
                    vnetSubnetId: virtualNetwork.akssubnet1.id,
                    osDiskSizeGb: 30,
                }],
            servicePrincipal: [{
                    clientId: props.azureAdConstruct.servicePrincipalAppId,
                    clientSecret: props.azureAdConstruct.servicePrincipalPassword,
                }],
            networkProfile: [{
                    networkPlugin: "azure"
                }],
            tags: JSON.parse(process.env.AZURETAG),
            dependsOn: [virtualNetwork.akssubnet1]
        });
        const get_image_var = new provider_null_1.Resource(this, "kubectlDownload", {
            triggers: {},
            dependsOn: [this.kubernetesCluster],
        });
        get_image_var.addOverride("provisioner.local-exec.command", `echo -n $(git symbolic-ref --short HEAD) > branch.txt && echo -n $(git rev-parse --short HEAD) > hash.txt`);
        const hash_content = new data_local_file_1.DataLocalFile(this, "hash_content", {
            filename: "hash.txt",
            dependsOn: [get_image_var],
        });
        const branch_content = new data_local_file_1.DataLocalFile(this, "branch_content", {
            filename: "branch.txt",
            dependsOn: [get_image_var],
        });
        this.kubectl = new provider_null_1.Resource(this, "kubectl", {
            triggers: {},
            dependsOn: [this.kubernetesCluster, get_image_var, props.keyVaultConstruct.keyVault, props.containerRegistry.builddocker],
        });
        const db_user = props.mysqlServerConstruct.mysqlServer.administratorLogin + "@" + props.mysqlServerConstruct.mysqlServer.name; // add + "@" + props.mysqlServerConstruct.mysqlServer.name for cloud mysql
        const db_pass = props.mysqlServerConstruct.mysqlServer.administratorLoginPassword; // same but k8s sql must use process.env.MYSQL_SERVER_ADMIN_PASSWORD
        const db_host = props.mysqlServerConstruct.mysqlServer.fqdn; //props.mysqlServerConstruct.mysqlServer.fqdn for azure cloud mysql // mysql-service for k8s mysql
        const db_name = process.env.MYSQL_SCHEMA_NAME;
        const image = props.containerRegistry.containerRegistry.loginServer + "/" + process.env.PROJECT_NAME + "-" + branch_content.content + ":" + hash_content.content;
        const vault_url = props.keyVaultConstruct.keyVault.vaultUri;
        const azure_client_id = props.azureAdConstruct.servicePrincipalAppId;
        const azure_client_secret = props.azureAdConstruct.servicePrincipalPassword;
        const azure_tenant_id = props.azureAdConstruct.servicePrincipalTenantId;
        const resource_group_name = resourceGroup.name;
        const kubernetes_name = this.kubernetesCluster.name;
        const azurecr_loginserver = props.containerRegistry.containerRegistry.loginServer;
        this.kubectl.addOverride("provisioner.local-exec.command", `az aks get-credentials --resource-group ${resource_group_name} --name ${kubernetes_name} --overwrite-existing && \
            cd ../../../pc_donation/ && export DB_USER=${db_user} && export DB_PASS=${db_pass} && export DB_HOST=${db_host} && export DB_NAME=${db_name} && export DB_PORT=3306 export IMAGE=${image} \
             export VAULT_URL=${vault_url} && export AZURE_CLIENT_ID=${azure_client_id} && export AZURE_CLIENT_SECRET=${azure_client_secret} && export AZURE_TENANT_ID=${azure_tenant_id} && \
             kubectl create secret generic web-secret --from-literal='IMAGE=${image}' --from-literal='port="3306"' --from-literal='username=${db_user}' --from-literal='password=${db_pass}' --from-literal='host=${db_host}' --from-literal='tablename=${db_name}' && \
             kubectl create secret docker-registry azurecr-secret --namespace default --docker-server=${azurecr_loginserver} --docker-username=${azure_client_id} --docker-password=${azure_client_secret} --
             kubectl apply -f mysql-deployment.yaml,mysql-service.yaml && \ 
             envsubst < web-deployment.yaml | kubectl apply -f - && kubectl apply -f web-service.yaml
             `
        // envsubst < web-deployment.yaml | kubectl apply -f - && kubectl apply -f web-service.yaml
        // kubectl apply -f mysql-deployment.yaml,mysql-service.yaml for k8s mysql, if use cloud mysql just delete it
        );
    }
}
exports.KubernetesClusterSConstruct = KubernetesClusterSConstruct;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia3ViZXJuZXRlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImt1YmVybmV0ZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkNBQXFDO0FBQ3JDLDhEQUF5RTtBQUt6RSx3REFBOEM7QUFFOUMsNkVBQXNFO0FBV3RFLE1BQWEsMkJBQTRCLFNBQVEsc0JBQVM7SUFHdEQsWUFDSSxLQUFnQixFQUNoQixJQUFZLEVBQ1osS0FBdUM7UUFFdkMsS0FBSyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVuQixNQUFNLEVBQUMsYUFBYSxFQUFFLGNBQWMsRUFBQyxHQUFHLEtBQUssQ0FBQztRQUc5Qyw0QkFBNEI7UUFDNUIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksb0NBQWlCLENBQzFDLElBQUksRUFDSixvQ0FBb0MsRUFDcEM7WUFDSSxJQUFJLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHO1lBQ2pELGlCQUFpQixFQUFFLGFBQWEsQ0FBQyxJQUFJO1lBQ3JDLFFBQVEsRUFBRSxhQUFhLENBQUMsUUFBUTtZQUNoQyxTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsTUFBTTtZQUMvRCxlQUFlLEVBQUUsQ0FBQztvQkFDZCxJQUFJLEVBQUUsTUFBTTtvQkFDWixTQUFTLEVBQUUsQ0FBQztvQkFDWixNQUFNLEVBQUUsaUJBQWlCO29CQUN6QixpQkFBaUIsRUFBRSxDQUFDLEdBQUcsRUFBQyxHQUFHLEVBQUMsR0FBRyxDQUFDO29CQUNoQyxpQkFBaUIsRUFBRSxJQUFJO29CQUN2QixRQUFRLEVBQUUsQ0FBQztvQkFDWCxRQUFRLEVBQUUsQ0FBQztvQkFDWCxZQUFZLEVBQUUsY0FBYyxDQUFDLFVBQVUsQ0FBQyxFQUFFO29CQUMxQyxZQUFZLEVBQUUsRUFBRTtpQkFDbkIsQ0FBQztZQUNG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S0FBSyxDQUFDLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQztRQUNsRixJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FDcEIsZ0NBQWdDLEVBQUUsMkNBQTJDLG1CQUFtQixXQUFXLGVBQWU7eURBQzdFLE9BQU8sc0JBQXNCLE9BQU8sc0JBQXNCLE9BQU8sc0JBQXNCLE9BQU8sd0NBQXdDLEtBQUs7Z0NBQ3BLLFNBQVMsOEJBQThCLGVBQWUsa0NBQWtDLG1CQUFtQiw4QkFBOEIsZUFBZTs4RUFDMUcsS0FBSywyREFBMkQsT0FBTyw4QkFBOEIsT0FBTywwQkFBMEIsT0FBTywrQkFBK0IsT0FBTzt3R0FDekosbUJBQW1CLHNCQUFzQixlQUFlLHNCQUFzQixtQkFBbUI7OztjQUczTDtRQUNGLDJGQUEyRjtRQUMzRiw2R0FBNkc7U0FDaEgsQ0FBQztJQUNOLENBQUM7Q0FDSjtBQTdGRCxrRUE2RkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbnN0cnVjdH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7S3ViZXJuZXRlc0NsdXN0ZXIsIFJlc291cmNlR3JvdXB9IGZyb20gXCJAY2RrdGYvcHJvdmlkZXItYXp1cmVybVwiO1xuaW1wb3J0IHtBenVyZUFkQ29uc3RydWN0fSBmcm9tIFwiLi9henVyZV9hZFwiO1xuaW1wb3J0IHtWaXJ0dWFsTmV0d29ya0NvbnN0cnVjdH0gZnJvbSBcIi4vdmlydHVhbF9uZXR3b3JrXCJcbmltcG9ydCB7Q29udGFpbmVyUmVnaXN0cnlTQ29uc3RydWN0fSBmcm9tIFwiLi9jb250YWluZXJfcmVnaXN0cnlcIlxuaW1wb3J0IHtLZXlWYXVsdENvbnN0cnVjdH0gZnJvbSBcIi4va2V5X3ZhdWx0XCJcbmltcG9ydCB7UmVzb3VyY2V9IGZyb20gXCJAY2RrdGYvcHJvdmlkZXItbnVsbFwiO1xuaW1wb3J0IHtNeVNRTFNlcnZlckNvbnN0cnVjdH0gZnJvbSBcIi4vbXlzcWxfc2VydmVyXCJcbmltcG9ydCB7RGF0YUxvY2FsRmlsZX0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2xvY2FsL2RhdGEtbG9jYWwtZmlsZVwiO1xuXG5pbnRlcmZhY2UgS3ViZXJuZXRlc0NsdXN0ZXJTQ29uc3RydWN0UHJvcHMge1xuICAgIHJlc291cmNlR3JvdXA6IFJlc291cmNlR3JvdXA7XG4gICAgdmlydHVhbE5ldHdvcms6IFZpcnR1YWxOZXR3b3JrQ29uc3RydWN0O1xuICAgIGF6dXJlQWRDb25zdHJ1Y3Q6IEF6dXJlQWRDb25zdHJ1Y3Q7XG4gICAgY29udGFpbmVyUmVnaXN0cnk6IENvbnRhaW5lclJlZ2lzdHJ5U0NvbnN0cnVjdDtcbiAgICBrZXlWYXVsdENvbnN0cnVjdDogS2V5VmF1bHRDb25zdHJ1Y3Q7XG4gICAgbXlzcWxTZXJ2ZXJDb25zdHJ1Y3Q6IE15U1FMU2VydmVyQ29uc3RydWN0O1xufVxuXG5leHBvcnQgY2xhc3MgS3ViZXJuZXRlc0NsdXN0ZXJTQ29uc3RydWN0IGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgICBwdWJsaWMgcmVhZG9ubHkga3ViZXJuZXRlc0NsdXN0ZXI6IEt1YmVybmV0ZXNDbHVzdGVyO1xuICAgIHB1YmxpYyByZWFkb25seSBrdWJlY3RsOiBSZXNvdXJjZTtcbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICAgICAgbmFtZTogc3RyaW5nLFxuICAgICAgICBwcm9wczogS3ViZXJuZXRlc0NsdXN0ZXJTQ29uc3RydWN0UHJvcHNcbiAgICApIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIG5hbWUpO1xuXG4gICAgICAgIGNvbnN0IHtyZXNvdXJjZUdyb3VwLCB2aXJ0dWFsTmV0d29ya30gPSBwcm9wcztcblxuXG4gICAgICAgIC8vIGNyZWF0ZSBjb250YWluZXIgcmVnaXN0cnlcbiAgICAgICAgdGhpcy5rdWJlcm5ldGVzQ2x1c3RlciA9IG5ldyBLdWJlcm5ldGVzQ2x1c3RlcihcbiAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICBcIklUUDQxMjEtUHJvamVjdCBrdWJlcm5ldGVzIENsdXN0ZXJcIixcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOiBwcm9jZXNzLmVudi5QUk9KRUNUX05BTUUhICsgcHJvY2Vzcy5lbnYuRU5WLFxuICAgICAgICAgICAgICAgIHJlc291cmNlR3JvdXBOYW1lOiByZXNvdXJjZUdyb3VwLm5hbWUsXG4gICAgICAgICAgICAgICAgbG9jYXRpb246IHJlc291cmNlR3JvdXAubG9jYXRpb24sXG4gICAgICAgICAgICAgICAgZG5zUHJlZml4OiBwcm9jZXNzLmVudi5QUk9KRUNUX05BTUUhICsgcHJvY2Vzcy5lbnYuRU5WICsgXCItZG5zXCIsXG4gICAgICAgICAgICAgICAgZGVmYXVsdE5vZGVQb29sOiBbe1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiBcIm5wMDFcIixcbiAgICAgICAgICAgICAgICAgICAgbm9kZUNvdW50OiAxLFxuICAgICAgICAgICAgICAgICAgICB2bVNpemU6IFwiU3RhbmRhcmRfRDRzX3YzXCIsXG4gICAgICAgICAgICAgICAgICAgIGF2YWlsYWJpbGl0eVpvbmVzOiBbXCIxXCIsXCIyXCIsXCIzXCJdLFxuICAgICAgICAgICAgICAgICAgICBlbmFibGVBdXRvU2NhbGluZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgbWluQ291bnQ6IDEsXG4gICAgICAgICAgICAgICAgICAgIG1heENvdW50OiAzLFxuICAgICAgICAgICAgICAgICAgICB2bmV0U3VibmV0SWQ6IHZpcnR1YWxOZXR3b3JrLmFrc3N1Ym5ldDEuaWQsXG4gICAgICAgICAgICAgICAgICAgIG9zRGlza1NpemVHYjogMzAsXG4gICAgICAgICAgICAgICAgfV0sXG4gICAgICAgICAgICAgICAgc2VydmljZVByaW5jaXBhbDogW3tcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50SWQ6IHByb3BzLmF6dXJlQWRDb25zdHJ1Y3Quc2VydmljZVByaW5jaXBhbEFwcElkLFxuICAgICAgICAgICAgICAgICAgICBjbGllbnRTZWNyZXQ6IHByb3BzLmF6dXJlQWRDb25zdHJ1Y3Quc2VydmljZVByaW5jaXBhbFBhc3N3b3JkLFxuICAgICAgICAgICAgICAgIH1dLFxuICAgICAgICAgICAgICAgIG5ldHdvcmtQcm9maWxlOiBbe1xuICAgICAgICAgICAgICAgICAgICBuZXR3b3JrUGx1Z2luOiBcImF6dXJlXCJcbiAgICAgICAgICAgICAgICB9XSxcblxuICAgICAgICAgICAgICAgIHRhZ3M6IEpTT04ucGFyc2UocHJvY2Vzcy5lbnYuQVpVUkVUQUchKSxcbiAgICAgICAgICAgICAgICBkZXBlbmRzT246IFsgdmlydHVhbE5ldHdvcmsuYWtzc3VibmV0MV1cbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgZ2V0X2ltYWdlX3ZhciA9IG5ldyBSZXNvdXJjZSh0aGlzLCBcImt1YmVjdGxEb3dubG9hZFwiLCB7XG4gICAgICAgICAgICB0cmlnZ2Vyczoge1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRlcGVuZHNPbjogW3RoaXMua3ViZXJuZXRlc0NsdXN0ZXJdLFxuICAgICAgICB9KTtcbiAgICAgICAgZ2V0X2ltYWdlX3Zhci5hZGRPdmVycmlkZShcInByb3Zpc2lvbmVyLmxvY2FsLWV4ZWMuY29tbWFuZFwiLFxuICAgICAgICAgICAgYGVjaG8gLW4gJChnaXQgc3ltYm9saWMtcmVmIC0tc2hvcnQgSEVBRCkgPiBicmFuY2gudHh0ICYmIGVjaG8gLW4gJChnaXQgcmV2LXBhcnNlIC0tc2hvcnQgSEVBRCkgPiBoYXNoLnR4dGBcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBoYXNoX2NvbnRlbnQgPSBuZXcgRGF0YUxvY2FsRmlsZSh0aGlzLCBcImhhc2hfY29udGVudFwiLCB7XG4gICAgICAgICAgICBmaWxlbmFtZTogXCJoYXNoLnR4dFwiLFxuICAgICAgICAgICAgZGVwZW5kc09uOiBbZ2V0X2ltYWdlX3Zhcl0sXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBicmFuY2hfY29udGVudCA9IG5ldyBEYXRhTG9jYWxGaWxlKHRoaXMsIFwiYnJhbmNoX2NvbnRlbnRcIiwge1xuICAgICAgICAgICAgZmlsZW5hbWU6IFwiYnJhbmNoLnR4dFwiLFxuICAgICAgICAgICAgZGVwZW5kc09uOiBbZ2V0X2ltYWdlX3Zhcl0sXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmt1YmVjdGwgPSBuZXcgUmVzb3VyY2UodGhpcywgXCJrdWJlY3RsXCIsIHtcbiAgICAgICAgICAgIHRyaWdnZXJzOiB7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZGVwZW5kc09uOiBbdGhpcy5rdWJlcm5ldGVzQ2x1c3RlciwgZ2V0X2ltYWdlX3ZhciwgcHJvcHMua2V5VmF1bHRDb25zdHJ1Y3Qua2V5VmF1bHQsIHByb3BzLmNvbnRhaW5lclJlZ2lzdHJ5LmJ1aWxkZG9ja2VyXSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgZGJfdXNlciA9IHByb3BzLm15c3FsU2VydmVyQ29uc3RydWN0Lm15c3FsU2VydmVyLmFkbWluaXN0cmF0b3JMb2dpbiArIFwiQFwiICsgcHJvcHMubXlzcWxTZXJ2ZXJDb25zdHJ1Y3QubXlzcWxTZXJ2ZXIubmFtZSAvLyBhZGQgKyBcIkBcIiArIHByb3BzLm15c3FsU2VydmVyQ29uc3RydWN0Lm15c3FsU2VydmVyLm5hbWUgZm9yIGNsb3VkIG15c3FsXG4gICAgICAgIGNvbnN0IGRiX3Bhc3MgPSBwcm9wcy5teXNxbFNlcnZlckNvbnN0cnVjdC5teXNxbFNlcnZlci5hZG1pbmlzdHJhdG9yTG9naW5QYXNzd29yZCAvLyBzYW1lIGJ1dCBrOHMgc3FsIG11c3QgdXNlIHByb2Nlc3MuZW52Lk1ZU1FMX1NFUlZFUl9BRE1JTl9QQVNTV09SRFxuICAgICAgICBjb25zdCBkYl9ob3N0ID0gcHJvcHMubXlzcWxTZXJ2ZXJDb25zdHJ1Y3QubXlzcWxTZXJ2ZXIuZnFkbiAgLy9wcm9wcy5teXNxbFNlcnZlckNvbnN0cnVjdC5teXNxbFNlcnZlci5mcWRuIGZvciBhenVyZSBjbG91ZCBteXNxbCAvLyBteXNxbC1zZXJ2aWNlIGZvciBrOHMgbXlzcWxcbiAgICAgICAgY29uc3QgZGJfbmFtZSA9IHByb2Nlc3MuZW52Lk1ZU1FMX1NDSEVNQV9OQU1FO1xuICAgICAgICBjb25zdCBpbWFnZT0gcHJvcHMuY29udGFpbmVyUmVnaXN0cnkuY29udGFpbmVyUmVnaXN0cnkubG9naW5TZXJ2ZXIgKyBcIi9cIiArIHByb2Nlc3MuZW52LlBST0pFQ1RfTkFNRSEgKyBcIi1cIiArIGJyYW5jaF9jb250ZW50LmNvbnRlbnQgKyBcIjpcIiArIGhhc2hfY29udGVudC5jb250ZW50IDtcbiAgICAgICAgY29uc3QgdmF1bHRfdXJsID0gcHJvcHMua2V5VmF1bHRDb25zdHJ1Y3Qua2V5VmF1bHQudmF1bHRVcmlcbiAgICAgICAgY29uc3QgYXp1cmVfY2xpZW50X2lkID0gcHJvcHMuYXp1cmVBZENvbnN0cnVjdC5zZXJ2aWNlUHJpbmNpcGFsQXBwSWQ7XG4gICAgICAgIGNvbnN0IGF6dXJlX2NsaWVudF9zZWNyZXQgPSBwcm9wcy5henVyZUFkQ29uc3RydWN0LnNlcnZpY2VQcmluY2lwYWxQYXNzd29yZDtcbiAgICAgICAgY29uc3QgYXp1cmVfdGVuYW50X2lkID0gcHJvcHMuYXp1cmVBZENvbnN0cnVjdC5zZXJ2aWNlUHJpbmNpcGFsVGVuYW50SWQ7XG4gICAgICAgIGNvbnN0IHJlc291cmNlX2dyb3VwX25hbWUgPSByZXNvdXJjZUdyb3VwLm5hbWU7XG4gICAgICAgIGNvbnN0IGt1YmVybmV0ZXNfbmFtZSA9IHRoaXMua3ViZXJuZXRlc0NsdXN0ZXIubmFtZTtcbiAgICAgICAgY29uc3QgYXp1cmVjcl9sb2dpbnNlcnZlciA9IHByb3BzLmNvbnRhaW5lclJlZ2lzdHJ5LmNvbnRhaW5lclJlZ2lzdHJ5LmxvZ2luU2VydmVyO1xuICAgICAgICB0aGlzLmt1YmVjdGwuYWRkT3ZlcnJpZGUoXG4gICAgICAgICAgICBcInByb3Zpc2lvbmVyLmxvY2FsLWV4ZWMuY29tbWFuZFwiLCBgYXogYWtzIGdldC1jcmVkZW50aWFscyAtLXJlc291cmNlLWdyb3VwICR7cmVzb3VyY2VfZ3JvdXBfbmFtZX0gLS1uYW1lICR7a3ViZXJuZXRlc19uYW1lfSAtLW92ZXJ3cml0ZS1leGlzdGluZyAmJiBcXFxuICAgICAgICAgICAgY2QgLi4vLi4vLi4vcGNfZG9uYXRpb24vICYmIGV4cG9ydCBEQl9VU0VSPSR7ZGJfdXNlcn0gJiYgZXhwb3J0IERCX1BBU1M9JHtkYl9wYXNzfSAmJiBleHBvcnQgREJfSE9TVD0ke2RiX2hvc3R9ICYmIGV4cG9ydCBEQl9OQU1FPSR7ZGJfbmFtZX0gJiYgZXhwb3J0IERCX1BPUlQ9MzMwNiBleHBvcnQgSU1BR0U9JHtpbWFnZX0gXFxcbiAgICAgICAgICAgICBleHBvcnQgVkFVTFRfVVJMPSR7dmF1bHRfdXJsfSAmJiBleHBvcnQgQVpVUkVfQ0xJRU5UX0lEPSR7YXp1cmVfY2xpZW50X2lkfSAmJiBleHBvcnQgQVpVUkVfQ0xJRU5UX1NFQ1JFVD0ke2F6dXJlX2NsaWVudF9zZWNyZXR9ICYmIGV4cG9ydCBBWlVSRV9URU5BTlRfSUQ9JHthenVyZV90ZW5hbnRfaWR9ICYmIFxcXG4gICAgICAgICAgICAga3ViZWN0bCBjcmVhdGUgc2VjcmV0IGdlbmVyaWMgd2ViLXNlY3JldCAtLWZyb20tbGl0ZXJhbD0nSU1BR0U9JHtpbWFnZX0nIC0tZnJvbS1saXRlcmFsPSdwb3J0PVwiMzMwNlwiJyAtLWZyb20tbGl0ZXJhbD0ndXNlcm5hbWU9JHtkYl91c2VyfScgLS1mcm9tLWxpdGVyYWw9J3Bhc3N3b3JkPSR7ZGJfcGFzc30nIC0tZnJvbS1saXRlcmFsPSdob3N0PSR7ZGJfaG9zdH0nIC0tZnJvbS1saXRlcmFsPSd0YWJsZW5hbWU9JHtkYl9uYW1lfScgJiYgXFxcbiAgICAgICAgICAgICBrdWJlY3RsIGNyZWF0ZSBzZWNyZXQgZG9ja2VyLXJlZ2lzdHJ5IGF6dXJlY3Itc2VjcmV0IC0tbmFtZXNwYWNlIGRlZmF1bHQgLS1kb2NrZXItc2VydmVyPSR7YXp1cmVjcl9sb2dpbnNlcnZlcn0gLS1kb2NrZXItdXNlcm5hbWU9JHthenVyZV9jbGllbnRfaWR9IC0tZG9ja2VyLXBhc3N3b3JkPSR7YXp1cmVfY2xpZW50X3NlY3JldH0gLS1cbiAgICAgICAgICAgICBrdWJlY3RsIGFwcGx5IC1mIG15c3FsLWRlcGxveW1lbnQueWFtbCxteXNxbC1zZXJ2aWNlLnlhbWwgJiYgXFwgXG4gICAgICAgICAgICAgZW52c3Vic3QgPCB3ZWItZGVwbG95bWVudC55YW1sIHwga3ViZWN0bCBhcHBseSAtZiAtICYmIGt1YmVjdGwgYXBwbHkgLWYgd2ViLXNlcnZpY2UueWFtbFxuICAgICAgICAgICAgIGBcbiAgICAgICAgICAgIC8vIGVudnN1YnN0IDwgd2ViLWRlcGxveW1lbnQueWFtbCB8IGt1YmVjdGwgYXBwbHkgLWYgLSAmJiBrdWJlY3RsIGFwcGx5IC1mIHdlYi1zZXJ2aWNlLnlhbWxcbiAgICAgICAgICAgIC8vIGt1YmVjdGwgYXBwbHkgLWYgbXlzcWwtZGVwbG95bWVudC55YW1sLG15c3FsLXNlcnZpY2UueWFtbCBmb3IgazhzIG15c3FsLCBpZiB1c2UgY2xvdWQgbXlzcWwganVzdCBkZWxldGUgaXRcbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=